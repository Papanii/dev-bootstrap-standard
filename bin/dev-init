#!/usr/bin/env bash
set -euo pipefail

# --------------------------------------------
# dev-init — Personal Dev Bootstrap Standard
# --------------------------------------------

FORCE=false

# Locate repo root (relative to this script)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
BIN_DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
ROOT_DIR="$(cd "$BIN_DIR/.." >/dev/null 2>&1 && pwd)"

VERSION_FILE="$ROOT_DIR/VERSION"
CLAUDE_TEMPLATE="$ROOT_DIR/templates/CLAUDE.section.md"
PR_TEMPLATE_SRC="$ROOT_DIR/templates/Pr-Template.md"

usage() {
  cat <<'EOF'
Usage: dev-init [--force] [--version] [--help]

Options:
  --force     Skip confirmation when outside $HOME/Development
  --version   Print version
  --help      Show help
EOF
}

ok()   { printf "✔ %s\n" "$*"; }
warn() { printf "⚠ %s\n" "$*" >&2; }
err()  { printf "✖ %s\n" "$*" >&2; }

need_cmd() { command -v "$1" >/dev/null 2>&1; }
is_tty()   { [[ -t 0 ]]; }

realpath_() {
  if need_cmd realpath; then
    realpath "$1"
  else
    pwd -P
  fi
}

inside_dev() {
  local cwd="$1"
  local dev="${HOME%/}/Development"
  [[ "${cwd}/" == "${dev}/"* ]] || [[ "$cwd" == "$dev" ]]
}

confirm_if_outside_dev() {
  local cwd="$1"
  local dev="${HOME%/}/Development"

  if inside_dev "$cwd"; then
    return 0
  fi

  if $FORCE; then
    warn "Outside $dev, but --force provided. Proceeding."
    return 0
  fi

  if ! is_tty; then
    err "Non-interactive shell and directory is outside $dev. Use --force."
    exit 2
  fi

  printf "This directory is not inside %s. Proceed? (y/n) " "$dev" >&2
  read -r ans
  [[ "$ans" == "y" ]] || { warn "Aborted."; exit 3; }
}

print_version() {
  if [[ -f "$VERSION_FILE" ]]; then
    echo "dev-init v$(cat "$VERSION_FILE")"
  else
    echo "dev-init (version unknown)"
  fi
}

# Collect all user input upfront before any file operations
collect_inputs() {
  local repo_name="$1"

  if ! is_tty; then
    PROJECT_DESC=""
    KANBAN_TITLE=""
    return
  fi

  printf "\n"
  printf "Project: %s\n" "$repo_name"
  printf "\n"

  printf "Short project description: " >&2
  read -r PROJECT_DESC

  printf "GitHub Projects board title (leave blank to skip): " >&2
  read -r KANBAN_TITLE

  printf "\n"
}

ensure_git_init() {
  if [[ ! -d ".git" ]]; then
    git init
    ok "Initialized git repository"
  else
    ok "Git repository already initialized"
  fi
}

generate_readme() {
  local name="$1"
  local desc="$2"

  if [[ -f "README.md" ]]; then
    ok "README.md already exists — skipping generation"
    return
  fi

  cat > README.md <<EOF
# ${name}

${desc}

## Overview

> Expand this section with architecture decisions, key concepts, and context
> that helps contributors (human or AI) understand the project quickly.

## Setup

\`\`\`bash
# Clone the repository
git clone <repo-url>
cd ${name}

# Install dependencies
# (add your setup steps here)
\`\`\`

## Development Workflow

1. Create a feature branch from \`main\`
2. Make your changes with clear, focused commits
3. Open a pull request using the project PR template
4. Request review and address feedback
5. Merge after approval

## Pull Request Process

All pull requests must follow the PR template at:
\`.github/PULL_REQUEST_TEMPLATE.md\`

Every PR must include:
- A clear problem statement linked to an issue
- A summary of changes
- Test evidence
- Rollback plan

Human review is mandatory before merging.
EOF

  ok "Generated README.md"
}

ensure_pr_template() {
  local dest=".github/PULL_REQUEST_TEMPLATE.md"

  if [[ ! -f "$PR_TEMPLATE_SRC" ]]; then
    err "Missing PR template source: $PR_TEMPLATE_SRC"
    exit 10
  fi

  mkdir -p ".github"

  if [[ -f "$dest" ]]; then
    ok "PR template already exists at $dest — skipping"
    return
  fi

  cp "$PR_TEMPLATE_SRC" "$dest"
  ok "Created $dest"
}

ensure_claude_md() {
  local file="CLAUDE.md"

  if [[ ! -f "$CLAUDE_TEMPLATE" ]]; then
    err "Missing template: $CLAUDE_TEMPLATE"
    exit 10
  fi

  local section
  section="$(cat "$CLAUDE_TEMPLATE")"
  local title
  title="$(head -n 1 "$CLAUDE_TEMPLATE")"

  if [[ ! -f "$file" ]]; then
    printf "%s\n\n" "$section" > "$file"
    ok "Created $file"
    return
  fi

  local tmp
  tmp="$(mktemp)"

  if grep -qF "$title" "$file"; then
    awk -v title="$title" -v newsec="$section" '
      BEGIN {insec=0}
      {
        if ($0 == title) { print newsec "\n"; insec=1; next }
        if (insec==1) {
          if ($0 ~ /^##[[:space:]]+/) { insec=0; print $0 }
          else { next }
        } else {
          print $0
        }
      }
    ' "$file" > "$tmp"
    mv "$tmp" "$file"
  else
    printf "%s\n\n" "$section" > "$tmp"
    cat "$file" >> "$tmp"
    mv "$tmp" "$file"
  fi

  ok "Updated $file"
}

create_initial_commit() {
  if git rev-parse HEAD >/dev/null 2>&1; then
    ok "Repository already has commits — skipping initial commit"
    return
  fi

  git add README.md .github/PULL_REQUEST_TEMPLATE.md CLAUDE.md 2>/dev/null || true
  git commit -m "chore: initial project setup"
  ok "Created initial commit"
}

create_github_repo() {
  local name="$1"

  if ! need_cmd gh; then
    warn "gh not found in PATH. Skipping GitHub repository creation."
    return
  fi

  if git remote get-url origin >/dev/null 2>&1; then
    ok "Remote origin already set: $(git remote get-url origin)"
    return
  fi

  printf "Creating GitHub repository '%s'...\n" "$name"
  gh repo create "$name" --source=. --public --push
  ok "GitHub repository created and pushed: $name"
}

create_github_project() {
  local title="$1"

  if [[ -z "$title" ]]; then
    warn "No Kanban board title provided. Skipping GitHub Projects board creation."
    return
  fi

  if ! need_cmd gh; then
    warn "gh not found in PATH. Skipping GitHub Projects board creation."
    return
  fi

  printf "Creating GitHub Projects board '%s'...\n" "$title"

  local output
  local code
  set +e
  output="$(gh project create --owner @me --title "$title" 2>&1)"
  code=$?
  set -e

  if [[ $code -eq 0 ]]; then
    ok "GitHub Projects board created: $title"
  elif echo "$output" | grep -q "missing required scopes"; then
    warn "GitHub Projects board creation failed — missing auth scopes."
    printf "  Run the following, then re-run dev-init:\n" >&2
    printf "  gh auth refresh -s project,read:project\n" >&2
  else
    warn "GitHub Projects board creation failed: $output"
  fi
}

main() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --force) FORCE=true; shift ;;
      --version) print_version; exit 0 ;;
      --help|-h) usage; exit 0 ;;
      *) err "Unknown option: $1"; usage; exit 64 ;;
    esac
  done

  local cwd
  cwd="$(realpath_ ".")"

  confirm_if_outside_dev "$cwd"

  local repo_name
  repo_name="$(basename "$cwd")"

  # Collect all prompts before touching the filesystem
  PROJECT_DESC=""
  KANBAN_TITLE=""
  collect_inputs "$repo_name"

  # File operations
  ensure_git_init
  generate_readme "$repo_name" "$PROJECT_DESC"
  ensure_pr_template
  ensure_claude_md

  # Commit before pushing
  create_initial_commit

  # GitHub operations
  create_github_repo "$repo_name"
  create_github_project "$KANBAN_TITLE"

  ok "Done."
}

main "$@"
